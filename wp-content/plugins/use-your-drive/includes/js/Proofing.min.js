(function(t){"use strict";t.widget("cp.WPCP_UseyourDrive_Proofing",{options:{listtoken:null},_create:function(){this._initializeOptions(),this._initializeData(),this._initiate()},_initializeOptions:function(){this.options.topContainer=this.element.parent(),this.options.mainContainer=this.options.main.element,this.options.loadingContainer=this.element.find(".loading"),this.options.statusBar=this.element.parent().find(".wpcp-proofing-status-bar"),this.options.supportTouch="ontouchstart"in window&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||navigator.maxTouchPoints>1,this.options.listtoken=this.element.attr("data-token"),this.options.account_id=this.element.attr("data-account-id"),this.options.drive_id=this.element.attr("data-drive-id"),this.options.max_items=parseInt(this.options.mainContainer.attr("data-max-items")),console.log(this.options.max_items)},_initializeData:function(){const t=new URLSearchParams(window.location.search);this.data={ident:t.get("ident"),user:null,items:[],approved:!0,labels:[]}},_destroy:function(){return this._super()},_setOption:function(t,e){this._super(t,e)},_initiate:function(){this._initProofing()},_initProofing:function(){this.getSelection(),this.setListeners(),this.setEvents(),this.options.statusBar.fadeIn()},setListeners:function(){const t=this;t.options.mainContainer.on("wpcp-content-loaded",(e,i)=>{i.element.find("input[name='selected-files[]']:checked").prop("checked",!1).removeClass("is-selected"),t.updateRender()})},setEvents:function(){const e=this;t(document).on("click",".entry-label-button",t=>{t.stopPropagation(),e._showLabelMenu(t)}),t(document).on("click",".entry_action_add_label",function(){const i=t(this).parents("[data-id]").attr("data-id"),n=t(this).parents("[data-label-id]").attr("data-label-id");"none"===n?e.deleteLabel(i):e.addLabel(i,n),tippy.hideAll(),e.updateRender(),e.saveSelection()}),t(document).on("change",".entry_checkbox input[name='selected-files[]']",function(){const i=t(this).parents("[data-id]").attr("data-id");t(this).is(":checked")?e.addSelected(i):e.deleteSelected(i),e.updateRender(),e.saveSelection()}),t(e.options.statusBar).on("click",".wpcp-proofing-filter-selected",()=>{e.options.topContainer.addClass("filter-selected").removeClass("filter-unselected")}),t(e.options.statusBar).on("click",".wpcp-proofing-filter-unselected",()=>{e.options.topContainer.addClass("filter-unselected").removeClass("filter-selected")}),t(e.options.statusBar).on("click",".wpcp-proofing-filter-reset",()=>{e.options.topContainer.removeClass("filter-unselected").removeClass("filter-selected")}),t(e.options.statusBar).on("click",".wpcp-proofing-save",()=>{e.saveSelection()}),t(e.options.statusBar).on("click",".wpcp-proofing-pre-send",()=>{e.getSelected().length<1||e.openDialog("#wpcp-proofing-pre-send-view")})},_showLabelMenu:function(e){const i=t(e.target),n=`\n            <ul data-id='${i.parents("[data-id]").attr("data-id")}'>\n                ${this.data.labels.map(t=>`<li data-label-id='${t.id}'><a class="entry_action_add_label"><i class='eva eva-bookmark eva-lg' style="color:${t.color}"></i>${t.title}</a></li>`).join("")}\n                </ul>\n                `;tippy(e.target,{content:n,trigger:"manual",allowHTML:!0,placement:this.is_rtl?"bottom-end":"bottom-start",appendTo:i.parents(".UseyourDrive").get(0),moveTransition:"transform 0.2s ease-out",interactive:!0,onShow:e=>{const i=t(e.reference).closest(".entry");i.addClass("hasfocus").addClass("popupopen")},onHide:e=>{t(e.reference).closest(".entry").removeClass("hasfocus").removeClass("popupopen")}}).show()},getItem:function(t){return this.data.items.find(e=>e.id===t)||null},addItem:function(t){let e=this.getItem(t);if(e)return e;const i=this.element.find('.entry[data-id="'+t+'"] .entry-info-name [data-name]').attr("data-name");return e={id:t,name:i,selected:null,label:null},this.data.items.push(e),e},addSelected:function(t){if(this.data.approved)return;this.addItem(t);const e=this.data.items.find(e=>e.id===t);e&&(e.selected=!0)},getSelected:function(){return this.data.items.filter(t=>t.selected)},deleteSelected:function(t){if(this.data.approved)return;const e=this.data.items.find(e=>e.id===t);e&&(e.selected=!1)},addLabel:function(t,e){if(this.data.approved)return;this.addItem(t);const i=this.data.items.find(e=>e.id===t);i&&(i.label=e)},getLabeled:function(){return this.data.items.filter(t=>t.label)},deleteLabel:function(t){if(this.data.approved)return;const e=this.data.items.find(e=>e.id===t);e&&(e.label=null)},renderSelected:function(){this.element.find(".is-selected").removeClass("is-selected"),t('.UseyourDrive .entry_checkbox input[name="selected-files[]"]').prop("checked",!1),this.getSelected().forEach(e=>{this.element.find('.entry[data-id="'+e.id+'"]').addClass("is-selected"),t('.UseyourDrive [data-id="'+e.id+'"] .entry_checkbox input[name="selected-files[]"]').prop("checked",!0)})},renderLabels:function(){this.element.find(".has-label").removeClass("has-label"),t(".UseyourDrive .entry-label-button i").css("color",""),this.getLabeled().forEach(e=>{const i=this.data.labels.find(t=>t.id===e.label);i&&(this.element.find('.entry[data-id="'+e.id+'"]').addClass("has-label"),t('.UseyourDrive [data-id="'+e.id+'"] .entry-label-button i').css("color",i.color))})},updateRender:function(){this.options.topContainer.removeClass("wpcp-proofing-readonly"),this.data.approved&&this.options.topContainer.addClass("wpcp-proofing-readonly"),this.renderSelected(),this.renderLabels();const t=this.getSelected().length;let e=t;this.options.max_items&&(e+=" / "+this.options.max_items),e+=" "+(1===t?this.options.str_item:this.options.str_items),this.options.statusBar.find(".wpcp-proofing-selected-num").text(e),this.options.statusBar.find(".wpcp-proofing-pre-send").prop("disabled",t<1||this.options.max_items&&t>this.options.max_items)},performAjaxRequest:function(e,i,n,s){const o=this;t.ajax({type:"POST",url:o.options.main.options.ajax_url,data:{action:"useyourdrive-proofing",account_id:o.options.account_id,drive_id:o.options.drive_id,listtoken:o.options.listtoken,ident:o.data.ident,_ajax_nonce:o.options.main.options.proofing_nonce,...e},beforeSend:function(){o.options.statusBar.find(".wpcp-proofing-save").hide(),o.options.statusBar.find(".wpcp-proofing-saving").show()},success:i,error:n,complete:function(){o.options.statusBar.find(".wpcp-proofing-save").show(),o.options.statusBar.find(".wpcp-proofing-saving").hide(),s&&s()},dataType:"json"})},getSelection:function(){const t={type:"get-selection"};this.performAjaxRequest(t,t=>{!0===t.success&&(this.data=t.data,this.updateRender())},()=>{},()=>{})},saveSelection:function(){const t={type:"save-selection",items:JSON.stringify(this.data.items)};this.performAjaxRequest(t,t=>{!0===t.success&&(this.data=t.data,this.updateRender())},()=>{this.openDialog("#wpcp-proofing-warning")},()=>{})},approveSelection:function(){const e={type:"approve-selection",items:JSON.stringify(this.data.items),approved:!0,message:t("#wpcp-proofing-approval-message").val()};this.performAjaxRequest(e,t=>{!0===t.success&&(this.data=t.data,this.updateRender()),this.openDialog("#wpcp-proofing-approved-view")},()=>{this.openDialog("#wpcp-proofing-warning")},()=>{})},openDialog:function(e){const i=this;t("#wpcp-modal-action").remove();const n=i.options.topContainer.find(e).html(),s=_.template(n),o={content_skin:i.options.main.options.content_skin,selected:i.getSelected().length},a=s(o);return t("body").append(a),t("#wpcp-modal-action .wpcp-modal-submit-btn").on("click",function(){t(this).prop("disabled",!0),t(this).html('<i class="eva eva-settings-outline eva-spin eva-fw"></i><span> '+i.options.str_processing+"</span>"),i.approveSelection()}),window.modal_action=new RModal(document.getElementById("wpcp-modal-action"),{bodyClass:"rmodal-open",dialogOpenClass:"animated slideInDown",dialogCloseClass:"animated slideOutUp",escapeClose:!0,afterClose(){}}),document.addEventListener("keydown",function(t){modal_action.keydown(t)},!1),modal_action.open(),!1}})})(jQuery);