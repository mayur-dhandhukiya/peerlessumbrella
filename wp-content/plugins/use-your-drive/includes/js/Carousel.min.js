(function(t){"use strict";t.widget("cp.WPCP_UseyourDrive_Carousel",{options:{listtoken:null},_create:function(){this.options.topContainer=this.element.parent(),this.options.mainContainer=this.element.find(".wpcp-carousel"),this.options.loadingContainer=this.element.find(".loading"),this.options.carouselContainer=this.element.find(".wpcp-carousel-main-container"),this.options.slideTemplate=this.element.find(".wpcp-carousel-item-template .wpcp-carousel-item"),this.options.supportTouch=!!("ontouchstart"in window)&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||navigator.maxTouchPoints>1,this.options.listtoken=this.element.attr("data-token"),this.options.account_id=this.element.attr("data-account-id"),this.options.drive_id=this.element.attr("data-drive-id"),this.images={},this.images_total=0,this.carousel=!1,this.is_paused=!1,this.playTimeout=null;let t=parseFloat(this.options.carouselContainer.attr("data-items"));this.options.carousel={container:this.options.carouselContainer.get(0),autoWidth:"horizontal"===this.options.carouselContainer.attr("data-axis")&&"1"===this.options.carouselContainer.attr("data-auto-size"),autoHeight:"vertical"===this.options.carouselContainer.attr("data-axis")&&"1"===this.options.carouselContainer.attr("data-auto-size"),mode:"carousel",axis:this.options.carouselContainer.attr("data-axis"),items:1,slideBy:1,edgePadding:0,gutter:0,loop:!0,center:!1,speed:parseInt(this.options.carouselContainer.attr("data-speed")),controls:"1"===this.options.carouselContainer.attr("data-navigation-arrows"),controlsPosition:"bottom",controlsText:['<i class="eva eva-chevron-left"></i>','<i class="eva eva-chevron-right"></i>'],autoplay:"1"===this.options.carouselContainer.attr("data-autoplay"),autoplayDirection:this.options.carouselContainer.attr("data-autoplayDirection"),autoplayHoverPause:"1"===this.options.carouselContainer.attr("data-autoplayHoverPause"),autoplayTimeout:parseInt(this.options.carouselContainer.attr("data-autoplayTimeout")),autoplayText:["▶","❚❚"],autoplayButtonOutput:!1,nav:!1,navPosition:"bottom",arrowKeys:!0,mouseDrag:!0,swipeAngle:!1,responsive:{630:{items:t<2?1:2,slideBy:t<2?1:2,gutter:"0"===this.options.carouselContainer.attr("data-auto-size")?this.options.carouselContainer.attr("data-gutter"):1,nav:"1"===this.options.carouselContainer.attr("data-nav"),mouseDrag:!0,center:"1"===this.options.carouselContainer.attr("data-center")},900:{slideBy:parseFloat(this.options.carouselContainer.attr("data-slideBy"))<=t?parseFloat(this.options.carouselContainer.attr("data-slideBy")):t,items:t}}},this._initiate()},_destroy:function(){return this._super()},_setOption:function(t,e){this._super(t,e)},_initiate:function(){let t=this;var e=t.buildRequest();e({},t)},_initCarousel:function(e){let o=this;if(!1===e)return o.options.mainContainer.find(".wpcp-carousel-preloading").remove(),void o.showError();t.isEmptyObject(e)?o.showError():(o.images_total=e.total,o.addImages(e.images),o.options.carousel.responsive[900].items>o.images_total&&(o.options.carousel.responsive[900].items=o.images_total,o.options.carousel.responsive[630].items=o.images_total<2?1:2),o.carousel=tns(o.options.carousel),o.carousel.pause(),o.carousel.events.on("indexChanged",function(e,i){o.is_paused=!1;let a=e.index-e.items<0?0:e.index-e.items,n=o.options.carousel.autoplayTimeout<500?5:2*e.items+1;"1"==o.options.carouselContainer.attr("data-auto-size")&&(n=parseFloat(o.options.carouselContainer.attr("data-items")));let s=Array.prototype.slice.call(e.slideItems,a,e.index+2*n),r=t(s).find(".wpcp-carousel-item-bg[data-src]");0!==r.length&&(o.options.mainContainer.find(".tns-slide-active .wpcp-carousel-item-bg.wpcp-carousel-item-bg-loading").length&&(o.is_paused=!0,o.carousel.pause()),o._fetchImages(r))}),o.carousel.events.emit("indexChanged",o.carousel.getInfo()),o.is_paused=!0,o.options.mainContainer.addClass("wpcp-carousel-loaded"),o.options.mainContainer.find(".wpcp-carousel-preloading").remove(),o._initLightbox(),o.setEvents(),"1"===o.element.attr("data-lightboxopen")&&o.element.find("div.ilightbox-group:visible").first().trigger("click"))},setEvents:function(){let e=this;t(e.options.carouselContainer).on({click:function(o){return!1===e.options.supportTouch||t(this).hasClass("is-touched")?(o.stopPropagation(),void(e.options.supportTouch?t(this).find(".entry_action_view").trigger("itap"):t(this).find(".entry_action_view").trigger("click"))):(e.options.carouselContainer.find(".wpcp-carousel-item.is-touched").removeClass("is-touched"),t(this).addClass("is-touched"),!1)}},".wpcp-carousel-item"),t(e.options.carouselContainer).on({click:function(o){var i=t(this).parents(".wpcp-carousel-item");return o.stopPropagation(),e.options.main._actionDownloadEntry(i,o)}},".entry_action_download"),t(e.options.carouselContainer).on({click:function(o){var i=t(this).parents(".wpcp-carousel-item");o.stopPropagation(),e.options.main._actionShareEntry(i,o)}},".entry_action_shortlink");let o=e.options.carouselContainer[0].querySelectorAll(".entry-description-button");t(o).on("click",function(t){t.stopPropagation()}),tippy(o,{trigger:"mouseenter focus click",arrow:!1,offset:0,content:function(t){return t.querySelector(".tippy-content-holder").innerHTML},maxWidth:350,allowHTML:!0,placement:"bottom",delay:[100,null],interactiveBorder:15,appendTo:e.element[0],moveTransition:"transform 0.2s ease-out",interactive:!0,onShow:function(t){tippy.hideAll()},onHide:function(t){}})},buildRequest:function(){let t=this;var e=e=>{t._initCarousel(e)};return t.options.main._pipeline({url:UseyourDrive_vars.ajax_url,type:"POST",dataType:"json",data:function(e){return e.action="useyourdrive-get-gallery",e.type="carousel",e.sort=t.element.attr("data-sort"),e.account_id=t.options.account_id,e.listtoken=t.options.listtoken,e.id=t.element.attr("data-id"),e._ajax_nonce=UseyourDrive_vars.gallery_nonce,e}},e)},addImages:function(e){let o=this;const i=Math.round(t(".wpcp-carousel").height()-20),a=Math.round(t(".wpcp-carousel").width());t.each(e,function(){var t=this;let e=o.options.slideTemplate.clone(),n=e.find(".wpcp-carousel-item-bg").get(0);if(n.setAttribute("data-src",t.url),e.attr("data-id",t.id).attr("data-name",t.name),o.options.carousel.autoWidth&&e.children().first().css({width:t.width&&t.height?Math.round(i*t.width/t.height):i,height:i}),o.options.carousel.autoHeight&&e.children().first().css({width:a,height:t.width&&t.height?Math.round(a*t.height/t.width):a}),e.find(".wpcp-carousel-item-date span").text(t.last_edited_time_str),e.find(".wpcp-carousel-item-title span").html(t.name),t.description?(e.find(".wpcp-carousel-item-description, .description-text").html(t.description),e.addClass("wpcp-has-description")):e.find(".wpcp-carousel-item-description").remove(),t.download_url?e.find(".entry_action_download").attr("href",t.download_url):e.find(".entry_action_download").remove(),t.lightbox_link){let i=e.find(".entry_action_view");i.addClass("ilightbox-group"),i.attr("data-src",t.url),i.attr("data-type","image"),i.attr("rel","ilightbox['"+o.options.listtoken+"']"),i.attr("data-options","thumbnail:'"+t.url+"'"),t.description&&i.attr("data-caption",t.description)}o.images[t.id]=e,o.options.carouselContainer.append(e)})},_fetchImages:function(e){let o=this;t.each(e,function(){t(this).css({"background-image":'url("'+t(this).attr("data-src")+'")'}),t(this).addClass("wpcp-carousel-item-bg-loading")});let i=imagesLoaded(o.options.carouselContainer.get(0),{background:".wpcp-carousel-item-bg-loading"});i.on("progress",function(e,i){var a=i.isLoaded?"loaded":"broken";let n=t(i.element);n.removeClass("wpcp-carousel-item-bg-loading"),"broken"!==a&&(n.removeClass("preloading").removeAttr("data-src"),n.prev(".preloading").remove(),n.css("opacity",1),n.parents(".wpcp-carousel-item").find(".wpcp-carousel-item-overlay").addClass("wpcp-visible"),n.parents(".wpcp-carousel-item").find(".wpcp-carousel-item-text").css("opacity",1),clearTimeout(o.playTimeout))}).on("done",function(t){}).on("always",function(t){o.is_paused&&(o.playTimeout=setTimeout(()=>{o.carousel.play()},o.options.carousel.autoplayTimeout))})},showError:function(){let t=this;t.options.carouselContainer.html('<p style="text-align:center;">'+t.options.str_no_filelist+"</p>")},_initLightbox:function(){let e,o=this,i="1"===o.element.attr("data-lightboxnav"),a="1"===o.element.attr("data-lightboxthumbs"),n=!1,s=!1;"click"===o.options.lightbox_showcaption?e=s="click":"mouseenter"===o.options.lightbox_showcaption?(e=o.options.lightbox_showcaption,s="mouseleave"):"false"==o.options.lightbox_showcaption||"No"==o.options.lightbox_showcaption?(e=!1,s=!1):(n=!0,e=!0,s=!0);let r={WPCP:o,skin:"UseyourDrive wpcp-lightbox "+o.options.lightbox_skin,path:o.options.lightbox_path,attr:"data-src",maxScale:1,minScale:.05,infinite:!0,slideshow:{pauseOnHover:!1,pauseTime:parseInt(o.options.carouselContainer.attr("data-autoplayTimeout")),startPaused:"1"!==o.element.attr("data-slideshow")},controls:{slideshow:i,arrows:i,thumbnail:a},caption:{start:n,show:e,hide:s},headerHeight:50,header:{start:!1,show:!1,hide:!1},thumbnails:{normalOpacity:.9,activeOpacity:1,maxHeight:100},show:{effect:!1},hide:{effect:!1},overlay:{opacity:1},keepAspectRatio:!0,callback:{onBeforeLoad:function(e,i){t(".ilightbox-holder").attr("data-token",o.options.listtoken)},onOpen:function(){o.carousel.pause()},onHide:function(){let e=this.ui.currentElement.find(".ilightbox-container [src]"),i=t('.entry_action_view[data-src="'+e.attr("src")+'"]:first').parents(".wpcp-carousel-item").index();o.carousel.goTo(i-o.carousel.getInfo().cloneCount),o.carousel.play()},onShow:function(e,i){let a=this;new LazyLoad({data_src:window.devicePixelRatio>1?"src-retina":"src",unobserve_entered:!0,use_native:!1,elements_selector:".ilightbox-thumbnail img.preloading",class_applied:"wpcp-lazy-applied",class_loading:"wpcp-lazy-loading",class_loaded:"wpcp-lazy-loaded",class_error:"wpcp-lazy-error",callback_loaded:function(e){t(e).removeClass("preloading preloading-lightbox-thumbnail"),t(e).prev(".preloading").remove(),t(e).parent().data({naturalWidth:e.width,naturalHeight:e.height}),a.positionThumbnails(null,null,null)},callback_load:function(e){t(e).removeClass("preloading preloading-lightbox-thumbnail"),t(e).prev(".preloading").remove(),t(e).parent().data({naturalWidth:e.width,naturalHeight:e.height}),a.positionThumbnails(null,null,null)}}),t(".ilightbox-container .ilightbox-wrapper, .ilightbox-container img, .ilightbox-container video, .ilightbox-container audio").on("contextmenu",function(t){return"Yes"===o.options.lightbox_rightclick||(t.preventDefault(),t.stopPropagation(),!1)});let n=e.currentElement.find(".ilightbox-container [src]");if(n.length>0&&1!==n.data("logged")){var s=t('.entry_action_view[data-src="'+n.attr("src")+'"]:first').parents(".wpcp-carousel-item").attr("data-id");n.data("logged",1),o.options.main._logEvent("log_preview_event",s)}}},errors:{loadImage:o.options.str_imgError_title,loadContents:o.options.str_xhrError_title},text:{next:o.options.str_next_title,previous:o.options.str_previous_title,slideShow:o.options.str_startslideshow},candownload:!1};if(i){t.isEmptyObject(this.lightBox)||o.lightBox.destroy();let e=o.element.find(".ilightbox-group");o.lightBox=e.WPCP_iLightBox(r)}else t.isEmptyObject(this.lightBox)||t.each(this.lightBox,function(){this.destroy()}),o.lightBox=[],o.element.find(".ilightbox-group").each(function(){o.lightBox.push(t(this).WPCP_iLightBox(r))})}})})(jQuery);